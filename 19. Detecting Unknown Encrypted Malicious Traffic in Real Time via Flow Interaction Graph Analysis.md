@[TOC](detecting Unknown Encrypted Malicious Traffic in Real Time via Flow Interaction Graph Analysis)

# 1. 引言

- 攻击者经常会（可以称之为滥用）使用流量加密技术来隐藏恶意行为，因为恶意流量加密后和正常流量会有相似的特征。
- 加密恶意流量可以绕过传统的检测方法。
- 传统方法多数是监督学习，同时依赖于对现有攻击方式的先验知识。
- 实施恶意流量检测是不依赖先验知识的，因此是尚未解决的问题。

因此，本文提出HyperVision，一种实时的，基于无监督机器学习模型的恶意流量监测系统。

他可以

- 通过一个压缩的，内存中的，基于流特征建立的图，检测之前未知的恶意流量攻击pattern、
  - 具体而言，通过检测不正常的交互/通信pattern来识别恶意流量。技术上通过广泛联通的，稀疏的，基于统计特征的特征图来实现流量模式的存储和发现。
  - 同时，通过构建一个信息论的模型，来证明我们的图模型所保存的信息已经接近理论上限。
  - 本模型有92的准确率和86的f1 score，同时能实现在0.83s内检测80.6Gb的流量数据。

加密恶意流量检测问题一直没有得到很好解决，因为较低的恶意加密流量比率，和各种不同的流量模式pattern。

![image-20231122082313484](C:\Users\8208191402\Desktop\笔记\图片\image-20231122082313484.png)

- 传统的基于签名的方法利用了深度包检测技术，在加密流量环境下，payload是不可见的，因此不再可用。
- 流量加密后，另一方面，流的特征和正常流量是相似的。
- 之前的方法是监督学习，即通过对现有攻击方式的特征标注的数据集进行训练。基于加密流量的攻击模式大多是未知pattern的，因此现有模型无法识别。
- 对于同时使用加密和非加密流量的攻击方式，因为二者具有完全不同的攻击流量模式，因此也无法检测。

加密流量的攻击行为是稳定的，也可以说是遵循一定步骤的。

- 首先，加密攻击行为是具有模式的，需要遵循一定的步骤实施攻击，也就产生了攻击者和受害者之间不同的流交互模式，这与正常的流交互模式是截然不同的。例如，垃圾邮件机器人和SMTP服务器之间的通讯，与用户邮箱和SMTP服务器之间的通信模式完全不同。

  ```mermaid
  graph LR
  c1(spam robot)--flow pattern1-->s(SMTP)
  c2(SMTP user)--flow pattern2-->s(SMTP)
  ```

- 即使攻击者加密流量的单个流和正常流量相似，但流的交互模式pattern截然不同。

- 本文根据正常通信流量的模式（正常通信流的大小、长短分布），来识别恶意流量的流交互模式，从而实现恶意流量监测。

- you are what you broadcast是通过尽可能多的探测使用的协议，来寻找恶意流量没能够成功伪造的部分，来识别。本文不区分协议，通过通信流之间的交互模式，来识别恶意交互，进而识别恶意流量。

方法复述

- 建立compact graph，用于捕获多个流之间的交互关系。
- 通过学习图上的结构特征，来识别未知模式的恶意流量。
- 通过学习图结构的特征，实现无监督学习，和不涉及payload的学习。

一些问题

- 如果直接把IP地址作为图上的顶点，用(ip1,port1,ip2,port2)来表示流量，就换产生稠密图，所产生的关系数量是庞大的，无法支撑实时检测任务。（依赖爆炸问题）

- 为此，我们调研了网络上流的大小分布（C. Estan and G. Varghese, “,” ACM Trans. Comput. Syst., vol. 21, no. 3, pp. 270–313, 2003.）（T. Yang et al., “Elastic sketch: adaptive and fast network-wide measurements,”
  in SIGCOMM. ACM, 2018, pp. 561–575）。

  - 大部分流都是短的
  - 大多数数据包都集中分布在较长的流上，而不是分散在多个流中。

- 因此，我们使用两种策略来分别记录、表示图中的长流和短流。

  - 对于短流，基于相似性来进行合并，减少图中边的数量。

  - 对于长流，使用概率分布拟合算法，来用已知分布来表示和保存流的交互关系。

    > 分布拟合，或称为概率分布拟合，是将已知的理论分布（如正态分布、指数分布等）与实际数据集进行比较，以选择最能反映数据特性的分布模型的一种统计方法。在这个过程中，我们可能需要调整模型的参数，这个过程也被称为参数估计。
    >
    > 简单来说，拟合分布就是通过找到最合适的参数，使得所选择的理论分布尽可能地接近实际观察到的数据分布。
    >
    > 比如，我们有一组数据，想知道这组数据是否符合正态分布。可以使用分布拟合的方法将数据与正态分布进行比较，然后调整正态分布的参数（均值和方差），使得正态分布尽可能地接近我们的数据。这样，我们就可以使用正态分布来描述我们的数据，以便进行进一步的分析。

设计，一个分四步的，轻量级无监督图学习方法。通过利用压缩图中维护的，丰富的图交互信息。

1. 分析图的连接性。具体通过提取图中的连通分量和识别不正常的分量，方法是对高维统计特征进行聚类。通过这种方法可以减少模型学习的开销。

   ```mermaid
   graph LR
   c1(high-level statistic feature)--cluster-->s1(connected component)
   c1(high-level statistic feature)--cluster-->s2(abnormal component)
   s1--exclude benign component-->s3(connectivity of graph)
   s2--exclude benign component-->s3(connectivity of graph)
   ```

2. 对图中的节点进行预聚类（pre-cluster）。具体通过边特征表示的，图本地连接性。这进一步减少了特征处理开销，使模型能达到实时检测的标准。

3. 提取关键节点。通过使用Z3 SMT solver，来最小化聚类数量，来解决节点覆盖问题。

4. 根据关键节点连接的边，对每个关键节点进行聚类，从而把abnormal异常边标记为加密恶意流量。关键节点是pre-cluster步骤中心的节点。

信息密度层面，即存储效率层面

为了量化表示本模型的优势，我们开发了一个专门的基于流记录的熵模型：一个基于信息论的框架，从理论上分析了现有恶意流量检测模型的，数据源所包含的信息量。

对比发现，目前基于采样和基于事件的流量数据源（NetFlow和Zeek）是无法维护流量的高准确度信息的。因此，我们不能指望他们来维护流交互信息，更无法用它来检测恶意流量了。

而基于图表示的模型可以完美保存（在数据处理不平等的前提下）基于图学习的检测算法所需要的流交互信息。具体而言，基于图存储的模型，可以逼近在无限存储空间环境下的理想数据源存储能力的上限，同时HyperVision使用的图，在所有现有数据源中，具有最高的信息密度。信息密度是准确和高效检测的基础。

HyperVision是基于因特尔的数据平台开发工具DPDK开发的。我们在模型上重放了92个攻击数据集，包含80个在我们虚拟私有云（VPC）上采集的新数据集。具体而言，在VPC上收集48种典型的加密恶意流量，包括

- 加密泛洪流量。"Flooding traffic" 通常用来描述**沿着所有的输出链路发送数据包的行为**。在特定的情况下，flooding 可能会对网络造成重大影响，尤其是当网络无法承受大量的数据流时。

- 网站攻击流量，例如利用网站漏洞。"Web vulnerability"（网页漏洞）指的是**网站或网络应用程序中的安全弱点**。攻击者能够利用这些弱点，进而攻击或破坏网站，窃取数据，或者对网站的正常运行造成影响。

  网页漏洞可能存在于网站的各个部分，包括服务器设置、网络连接、数据库系统、应用程序代码等等。以下是一些常见的网络漏洞：

  1. SQL注入：攻击者通过输入恶意的SQL查询语句，从而查询、修改甚至删除数据库中的数据。
  2. 跨站脚本 (XSS)：攻击者插入恶意的JavaScript代码，在用户浏览网页时执行。
  3. 跨站请求伪造 (CSRF)：攻击者诱导用户发起恶意请求，通常是在用户并未意识到的情况下。
  4. 服务器漏洞：服务器软件（如Apache、Nginx等）未及时更新，未修复的漏洞可能被攻击者利用。
  5. 文件上传漏洞：网站对用户上传文件的处理不当，可能被用来上传并执行恶意代码。
  6. 信息泄露：比如敏感数据的未经加密的传输，或者服务器信息的无意泄露，给攻击提供了可利用信息。

  网页漏洞的发现和修复是网络安全中的重要任务。这通常需要开发者和网络管理员不断更新软件，加强代码审查，使用安全工具检测漏洞，并及时修复已发现的漏洞。

- 恶意软件攻防信息。包括可连接性测试，依赖更新，下载等等软件行为。通过对骨干网络流量进行重放，并作为后台流量的环境下，HyperVision可以实现更高的准确率。除了44个现实环境中稳定的流量无法识别（例如，基于cve-2020-36516的先进的测信道攻击方法，以及很多新发现的挖矿攻击方法）。

contributions：

- 第一个实时的、无监督的、加密恶意流量检测系统。通过利用保存流交互信息的图，可以识别基于恶意流量的未知攻击模式。
- 使用算法，构建可以存储在内存中的图，来准确的，实时的获取不同流之间的交互信息。
- 轻量级，无监督的加密流量检测方法，通过构建图上的特征。
- 构建基于信息论的理论分析框架，证明我们的模型能够捕获理论上最多的流量交互信息。
- 测试

![image-20231122100439359](C:\Users\8208191402\Desktop\笔记\图片\image-20231122100439359.png)

# 2. 威胁模型和设计目标

HyperVision使用port mirror技术，在路由器上进行流量重放，进而实现恶意流量监测的同时，不会影响实际的流量转发（forward）。识别出恶意流量后，可以结合目前的恶意流量防御方法，来控制检测出的流量的路由和隔离。在加密流量中，我们默认无法获取和解析应用层的header和负载内容。

本系统无法考虑被动攻击，因为被动攻击不会产生攻击者到受害者的流量，无法构成一个联通的图，也就无法用图模型来解决。

根据目前的调研，攻击者会事先通过侦查步骤来调查受害者的信息，包括用户密码、一个TLS连接中使用的TCP序列号，以及web服务器的随机内存分布结构。这些信息是攻击者在缺乏先验知识的前提下无法获得的，攻击者往往会通过多个不同ip地址发起攻击。

> "randomized memory layout of web server"，在计算机安全领域常常涉及到一种被称为"地址空间布局随机化"（Address Space Layout Randomization，简称ASLR）的技术。
>
> 在过去，攻击者经常利用程序中预测性的内存布局来执行攻击，如缓冲区溢出攻击，其提前计算出了一段代码或数据可能被加载到的内存地址，通过制造缓冲区溢出来让程序执行预置的恶意代码。
>
> ASLR是一种安全策略，通过随机化进程的地址空间布局来阻止这样的攻击。这意味着每次运行程序或重启计算机时，程序中的代码和数据在内存中的位置都会被随机地改变。这使得攻击者很难预测出恶意输入应该被放在哪里。因此，利用ASLR可以有效防止某些类型的攻击，尤其是跳转到固定地址的代码注入攻击。
>
> 当我们谈论"randomized memory layout of web server"时，我们通常是在讨论如何将ASLR应用到web服务器的环境中，以保护其对抗潜在的内存攻击。这包括随机化堆、栈、内存映射区域等内存布局，使得恶意攻击更加困难。这为提高系统的安全性提供了一层额外的保护。

设计目的：

- 广泛的检测能力，即能对加密流量和非加密流量进行检测。

- 实时的，高速的流量数据处理，能对经过HyperVision的流量进行实时恶意检测。

- 无监督的检测，即不需要对加密恶意流量数据的先验知识，也代表了能够识别之前未知的、未被揭露的攻击模式（例如zero-day attack）。因此我们的训练数据不包含带标签的数据集流量。

  > "Zero-day attack"（零日攻击）是指利用软件或硬件中尚未被公开，因此尚未被修复的安全漏洞进行的攻击。"零日"这个术语的来源是因为从这种安全漏洞被发现开始计算，到开发者制定并发布补丁的时间，开发者有"零天"的反应时间。
  >
  > 零日攻击是网络安全中的一大威胁。由于开发者和用户在受到攻击时可能还不知道存在这个漏洞，因此往往在受到攻击后才会发现并开始修复。在这段时间里，攻击者可以利用这个漏洞进行各种破坏，比如窃取信息、控制设备、破坏数据等。

# 3. HyperVision总览

![image-20231122100439359](C:\Users\8208191402\Desktop\笔记\图片\image-20231122100439359.png)

> 恶意流量的单个流在加密后和正常流量类似，因此难以检测。
>
> 但是恶意行为本身是有目的性的，就和通信流量具有目的性一样，因此恶意流量也有固定的模式。具体来说，在攻击者和受害者之间的交互模式与正常流量有显著差异。
>
> 通过学习压缩图中表示的交互模式，进而检测异常交互模式，就可以发现恶意流量。交互模式可以通过图中的特征（点、边、度。路径。循环、联通分量、子图）来表示。图特征抽象表示可以不用考虑流所使用的协议和种类。

- Graph Contraction

![image-20231122103300377](C:\Users\8208191402\Desktop\笔记\图片\image-20231122103300377.png)

- 收集流，构建图，同时把流分为长和短两类，分别记录对应的交互方式，用于初步减少图的稠密度。在图中，我们使用不同的ip地址作为节点。
  - 对于短flow，根据相似度进行group，每一组只保留一条边。
  - 对于长flow，使用概率模型，对包特征的分布进行拟合（用包特征来表示flow，从而减少长flow中包的数量和信息量），这样既确保了流特征是细粒度的（包特征构建的），又确保了流的交互模式能被准确保留，同时压缩流的数量。

- graph preprocessing

![image-20231122105817787](C:\Users\8208191402\Desktop\笔记\图片\image-20231122105817787.png)

- 目的是进一步减少图中包含的节点和边，减少对图进行特征提取和模式提取的开销。
- 方法是提取图中的连通分量，并通过高层次的统计信息，对连通分量进行聚类。聚类过程中，模型可以识别只包含正常流量交互方式的连通分量，从而**把这些连通分量过滤掉，减少恶意流量交互图的规模**。
- 然后，通过预聚类，之后我们就可以用聚类的中心点的交互关系来表示聚类内部其他点之间的交互关系。

- Malicious traffic detection based on graph

![image-20231122105827364](C:\Users\8208191402\Desktop\笔记\图片\image-20231122105827364.png)

- 通过对图特征的分析，识别加密流量。

- 通过识别图中的关键节点，来确保基于聚类的图学习过程，能够以最小的聚类数量来处理所有的特征模式边。*这是一个节点覆盖问题，即通过最小点集来包含所有的边。*

- 对于选出的最小聚类集合中的每个聚类中心点，把所有相连接的边根据流特征和结构特征进行聚类。这两者可以代表流交互的特征。

  > 1. **Flow Feature（流特征）：** 这可能涉及到关于流的性质和特征的信息。例如，流的速率、方向、频率、大小等都可以是流特征。在网络或系统中，流特征可能表示数据流、通信流、或其他资源的传递方式和属性。
  > 2. **Structural Feature（结构特征）：** 这可能涉及到组件之间关系的结构性信息。这包括了网络拓扑结构、系统架构、或其他组件之间的连接方式。在分析流交互模式时，结构特征可能指示了组件之间的关系，这些关系可以影响流的传递和交互。

- HyperVision通过计算当前流的聚类损失函数（距离已知聚类的距离）来识别恶意的边/流量。

# 4. 图构建

![image-20231122103300377](C:\Users\8208191402\Desktop\笔记\图片\image-20231122103300377.png)

## 4.1 流分类

![image-20231122110101130](C:\Users\8208191402\Desktop\笔记\图片\image-20231122110101130.png)

对流进行分类处理，减少依赖激增问题。

- 如图2，通过流大小的概率分布，把流分为长和短两类。图2展示了一个流从产生到结束的时间分布（FCT distribution）和流的长度分布。可以看出，

  - 95%的flow持续时间小于2s
  - 数据集94%的包集中在长flow中。
  - 因此，我们对长短流使用不同的流信息收集策略。

- 通过从高速数据平台的数据包解析引擎上poll per-packet信息，从中提取（source addr，destination addr，port numbers， per-packet features{protocols,lengths,arrival intervals}）这些信息无论是加密流量还是plain-text流量都能获得。

- 基于上述特征，设计一个flow classification算法：

  ![image-20231122110914240](C:\Users\8208191402\Desktop\笔记\图片\image-20231122110914240.png)

  通过维护：

  1. 计时器TIME_NOW

  2. 哈希表，使用（src，dst,src_port,dst_port）为key，对应特征中包含key的flows为value。

  3. 算法每经过JUDGE_INTERVAL检查一次哈希表：以TIME_NOW+PKT_TIMEOUT之前到达的最后一个包作为边界，检验表中flows的完整性。

  4. 确保flow完整之后，根据阈值FLOW_LINE进行长短流分类。

  5. 超参数选择：

     ![image-20231122111529423](C:\Users\8208191402\Desktop\笔记\图片\image-20231122111529423.png)

  6. 获取的per-packet information不包含数据平台记录的flow states，以防止攻击者篡改（测信道攻击和evading detection）。

     > 流状态可以包括一系列的属性和信息，以描述数据流的当前情况和性能。以下是一些可能包含在流状态中的信息：
     >
     > 1. **数据包的数量和大小：** 描述当前数据流中有多少个数据包，以及它们的大小。
     > 2. **传输速率：** 描述数据流的当前传输速率，即数据包在网络中传输的速度。
     > 3. **延迟：** 描述数据包从发送到接收之间的时间延迟。
     > 4. **丢包率：** 描述数据流中发生丢包的频率，即发送的数据包未能成功到达目的地。
     > 5. **协议信息：** 描述数据流所使用的通信协议，例如TCP或UDP。
     > 6. **连接状态：** 描述数据流的连接状态，例如是否已建立连接、正在传输中、或已关闭。
     >
     > 流状态的监测和管理对于网络性能优化、故障排除和安全性非常重要。通过实时监测和分析流状态，网络管理员可以更好地了解网络中的数据流动，并采取必要的措施来优化性能、保障服务质量，或者检测潜在的问题。

## 4.2 短流融合

  使用传统的ip通信四元组表示flow，作为图的边，会导致依赖激增。

  基于大部分short flow有几乎相同的，包级别的特征序列。

  当两个流：

  - 有相同的src和/或dst addr时（排列组合生成四种边），表示两个流可能有相同的行为。
  - 使用相同的协议类型
  - 除这两个流之外，同类流中还有足够多的样本数量，表示这些流的行为具有可重复性。

  就可以为这些流建立一个边，为所有的流维护一个共同的特征序列{protocols,lengths,arrival intervals}。因此，对于短流聚类，图中存在四种边：原地址融合的，目的地址融合的，双地址融合的，没有融合的（无法聚类的）。这些边连接的节点可能是一个地址，也可能是一组地址。

![image-20231122123550698](C:\Users\8208191402\Desktop\笔记\图片\image-20231122123550698.png)

下图展示了传统把流作为边的方法和我们的方法对比，节点直径表示聚类的addr数量，颜色深度表示重复的边的数量。

![image-20231122124644551](C:\Users\8208191402\Desktop\笔记\图片\image-20231122124644551.png)

## 4.3 长流特征分布拟合

之前提到，可以用矩形图来长flow中的包级别特征分布，从而减少特征序列的长度。

具体而言，用一个哈希表，设置bucket长度为10bytes，时间间隔1ms，对包级别的特征计算哈希值，存储到对应位置，同时增加counter计数。

流级别的特征不足以执行恶意流量检测，必须要精确到每个包。

![image-20231122132458946](C:\Users\8208191402\Desktop\笔记\图片\image-20231122132458946.png)

可以确定，包长和抵达时间分布式正态的。

在左图的包数量中，数量就是掩码。只需要使用11个bucket，每个bucket收集超过200个包，就可以实现高效表示和长度削减。

在右图的包长特征中，长度就是掩码。121buckets，每个bucket收集71个包。

在flow的协议特征上也用类似的方法。使用flow协议的掩码mask，作为选择bucket的哈希码，鉴于协议数量限制，选择更少的bucket。

# 5. 图的预聚类

包括寻找关键子图和对边进行预聚类。

## 5.1 连通性分析

![image-20231122135645692](C:\Users\8208191402\Desktop\笔记\图片\image-20231122135645692.png)

使用深度优先搜索，寻找图中所有的连通分量，根据连通分量进行划分。图5a表示了大多数连通分量包含少量的边和相似的交互模式（图结构）。

找到连通分量后，通过高层特征，对连通分量使用聚类方法，捕获异常连通分量：包含超过一种大聚类损失顺序。

连通分量的五种特征：

- 长flow数量
- 短flow数量
- 短flow group所引出的边的数量
- 长flow的字节数
- 短flow的字节数

用min-max正则化，结合密度聚类算法DBSCAN，来获取聚类中心。对每个连通分量，计算到最近中心的距离，当距离超过距离分布的99%位点时，认为是异常的。

图5b展示了一种聚类实例。大部分连通分量都是小的，大部分大连通分量都被标记成恶意的。正常连通分量的边表示的flow为正常的，恶意连通分量的边在下面进一步分析。

## 5.2 边的预聚类

异常连通分量包含很多点和边，因此无法直接用图表示学习，如图神经网络来进行实时检测。

![image-20231122141545146](C:\Users\8208191402\Desktop\笔记\图片\image-20231122141545146.png)

根据对边的分布分析，边的分布是稀疏的，而且大多和相似的边聚在一起。因此使用DBSCAN来实现高效的本地搜索和聚类中心选择，用于代替聚类的其他相同的聚类表示所有的边（flow）。

具体而言，对长flow和短flow分别选取8/4个图结构特征，包括入度，连接的边类型等等。恶意流量的这些特征与正常流量有显著区别，例如垃圾邮件机器人的出度大于正常用户，因为垃圾机器人要和服务器频繁通信。

获取特征后，使用min-max正则化，对DBSCAN使用小的搜索范围和大的最小聚类节点数，来避免不相关的边被包含到聚类中，因此会导致false positive。对于无法满足聚类条件的边视作outliner，只有一个边的聚类。

# 6. 恶意流量检测

![image-20231122145641078](C:\Users\8208191402\Desktop\笔记\图片\image-20231122145641078.png)

通过检测异常交互模式，即在图中把连接到同一个关键节点的边聚类，检测到的outliner就是恶意流量。

## 6.1 识别关键节点

为了提高有效性，只对关键节点连接的边聚类。对于每一个连通分量，选择其中的一个子集作为关键节点：

- 节点的源和/或目的地址是相同的，这样就可以确保每一条边至少连接到至少一个关键节点上，从而确保每条边至少被聚类一次。
- 自己包含最小数量的节点（点覆盖问题），目的是减少聚类的节点数量。点覆盖问题是优化问题，是NP Complete问题。
- 具体方案，通过把每个连通分量的所有节点和边规划到一个可满足模块上（satisfiability module），使用 Z3 SMT solver来处理。因为之前执行过预聚类和流裁剪，这个问题可以实时解决。

## 6.2 边特征聚类，用于检测

使用的特征：

- 第五步中提取的，flow的结构特征。（点、边、度。路径。循环、联通分量、子图）
- 对短flow，每个包中提取的特征序列。（source addr，destination addr，port numbers， per-packet features{protocols,lengths,arrival intervals}）
- 对长flow，对特征的分布拟合后，显著的特征部分。

![image-20231122151316739](C:\Users\8208191402\Desktop\笔记\图片\image-20231122151316739.png)

对长短流使用k-means算法分别聚类，计算损失函数来表明flow的可以程度：
$$
loss_{center}(edge)=min_{c_i \in \{c_1,...,c_k\}}||c_i-f(edge)||_2\\
loss_{cluster}(edge)=TimeRange(c(edge))\\
loss_{count}(edge)=log_2(Size(c(edge)+1))\\
loss(edge)=\alpha loss_{center}(edge) +\beta loss_{cluster}(edge) +\gamma loss_{count}(edge)\\
K: number \quad of \quad clusters\\
c_i:ith \quad center\\
f(edge):feature \quad vector\\
c(edge):all \quad edges\quad  in\quad  the\quad  cluster\quad  produced\quad  by\quad  pre-clustering\\
loss_{center}(edge):到聚类中心点的欧氏距离，表示这个特征和其他连接到同一关键节点特征的差异性\\ 
loss_{cluster}(edge):预聚类中，聚类所覆盖的时间范围。持续时间长的交互模式往往是正常的。\\
loss_{count}(edge):由边数表示的，flows数量。突然增长的大量流表示可能的恶意行为。\\
用三个参数平衡相关性。
$$
loss大于某阈值，则恶意。

# 7. 理论分析

理论分析模块：flow recording entropy model，用于分析图中保存的信息量的大小。

## 7.1
